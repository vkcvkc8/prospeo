<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prospeo Email Finder Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      color: #2d3748;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      color: #718096;
      font-size: 1.1rem;
    }

    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }

    .alert-success {
      background: #f0fff4;
      border-color: #38a169;
      color: #2f855a;
    }

    .alert-error {
      background: #fed7d7;
      border-color: #e53e3e;
      color: #c53030;
    }

    .alert-info {
      background: #ebf8ff;
      border-color: #3182ce;
      color: #2c5282;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin: 16px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      width: 0%;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .stat-card {
      background: #f7fafc;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      border: 2px solid #e2e8f0;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
    }

    .stat-label {
      color: #718096;
      font-size: 0.9rem;
      margin-top: 4px;
    }

    .form-section {
      display: grid;
      gap: 20px;
      margin-bottom: 30px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      font-weight: 600;
      color: #4a5568;
      font-size: 0.9rem;
    }

    input[type="text"], input[type="file"] {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s;
      background: #f7fafc;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #cbd5e0;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .log-section {
      margin-top: 30px;
    }

    .log-section h3 {
      color: #2d3748;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }

    #log {
      height: 300px;
      overflow-y: auto;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      background: #f7fafc;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.4;
    }

    .status-section {
      margin-top: 20px;
      padding: 16px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .status-section h4 {
      color: #2d3748;
      margin-bottom: 8px;
    }

    #lastResponse {
      color: #4a5568;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      word-break: break-all;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: #e53e3e;
    }

    .success {
      color: #38a169;
    }

    .info {
      color: #3182ce;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîç Prospeo Email Finder</h1>
      <p>Find professional email addresses from CSV data with advanced processing</p>
    </div>

    <div id="alertContainer"></div>

    <div class="form-section">
      <div class="input-group">
        <label for="apiKeyInput">Prospeo API Key</label>
        <input type="text" id="apiKeyInput" placeholder="Enter your Prospeo API key..." value="">
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="testApiKey()" id="testBtn">
          <span id="testBtnText">üß™ Quick API Test</span>
        </button>
      </div>

      <div class="input-group">
        <label for="fileInput">Upload CSV File</label>
        <input type="file" id="fileInput" accept=".csv">
        <small style="color: #718096;">CSV should contain columns: first_name, last_name, company</small>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="processCSV()" id="processBtn">
          <span id="processBtnText">üöÄ Process CSV</span>
        </button>
        <button class="btn-secondary" onclick="clearLogs()">üßπ Clear Logs</button>
      </div>

      <div id="progressSection" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="processedCount">0</div>
            <div class="stat-label">Processed</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="foundCount">0</div>
            <div class="stat-label">Emails Found</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="remainingCount">0</div>
            <div class="stat-label">Remaining</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="estimatedTime">0m</div>
            <div class="stat-label">Est. Time Left</div>
          </div>
        </div>
      </div>
    </div>

    <div class="log-section">
      <h3>üìä Processing Logs</h3>
      <div id="log">Welcome to Prospeo Email Finder! üéâ<br>1. Enter your API key<br>2. Test the connection<br>3. Upload your CSV file<br>4. Process and download results<br><br>Ready to find some emails! üöÄ</div>
    </div>

    <div class="status-section">
      <h4>üìã Last API Response</h4>
      <div id="lastResponse">No API calls made yet</div>
    </div>
  </div>

  <script>
    let isProcessing = false;
    let processedCount = 0;
    let foundCount = 0;
    let totalCount = 0;

    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `
        <strong>${type === 'error' ? '‚ùå Error:' : type === 'success' ? '‚úÖ Success:' : '‚ÑπÔ∏è Info:'}</strong> ${message}
        <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
      `;
      alertContainer.appendChild(alert);
      
      // Auto-remove after 5 seconds for non-error messages
      if (type !== 'error') {
        setTimeout(() => {
          if (alert.parentElement) {
            alert.remove();
          }
        }, 5000);
      }
    }

    function updateProgress(processed, total, found) {
      processedCount = processed;
      foundCount = found;
      totalCount = total;
      
      const progressFill = document.getElementById('progressFill');
      const processedCountEl = document.getElementById('processedCount');
      const foundCountEl = document.getElementById('foundCount');
      const remainingCountEl = document.getElementById('remainingCount');
      const estimatedTimeEl = document.getElementById('estimatedTime');
      
      const percentage = (processed / total) * 100;
      progressFill.style.width = `${percentage}%`;
      
      processedCountEl.textContent = processed;
      foundCountEl.textContent = found;
      remainingCountEl.textContent = total - processed;
      
      // Calculate estimated time (1.5 seconds per request)
      const remainingRequests = total - processed;
      const estimatedSeconds = remainingRequests * 1.5;
      const estimatedMinutes = Math.ceil(estimatedSeconds / 60);
      estimatedTimeEl.textContent = `${estimatedMinutes}m`;
    }
    async function fetchEmail(firstName, lastName, company, apiKey) {
      if (!apiKey) {
        logMessage("‚ùå Error: API key is missing", "error");
        showAlert("API key is missing", "error");
        return null;
      }
      if (!company) {
        logMessage("‚ùå Error: Company field is required", "error");
        showAlert("Company field is required", "error");
        return null;
      }

      // Try direct API call with proper CORS handling
      const url = 'https://api.prospeo.io/email-finder';
      const requestData = {
        first_name: firstName || '',
        last_name: lastName || '',
        company: company
      };

      try {
        logMessage(`üîç Searching for: ${firstName} ${lastName} @ ${company}`, "info");
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-KEY': apiKey,
            'Accept': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          let errorMessage = `HTTP error! status: ${response.status}`;
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorMessage;
          } catch (e) {
            // If we can't parse error response, use status message
          }
          throw new Error(errorMessage);
        }

        const result = await response.json();
        logMessage(`‚úÖ API request successful for ${firstName} ${lastName}`, "success");
        return JSON.stringify(result);
      } catch (error) {
        logMessage(`‚ùå Fetch error: ${error.message}`, "error");
        
        // If CORS error, show helpful message
        if (error.message.includes('CORS') || error.message.includes('fetch')) {
          showAlert("CORS error detected. The browser is blocking direct API calls. Consider using a proxy server for production.", "error");
        }
        return null;
      }
    }

    function logMessage(message, type = "info") {
      const log = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === "error" ? "error" : type === "success" ? "success" : "info";
      log.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span><br>`;
      log.scrollTop = log.scrollHeight;
    }

    function updateLastResponse(response) {
      const lastResponseEl = document.getElementById('lastResponse');
      if (response) {
        try {
          const jsonResponse = JSON.parse(response);
          const email = jsonResponse.response?.email || 'No email found';
          const status = jsonResponse.response?.email_status || 'NO_RESULT';
          lastResponseEl.innerHTML = `<strong>Email:</strong> ${email}<br><strong>Status:</strong> ${status}`;
        } catch (e) {
          lastResponseEl.textContent = response.substring(0, 200) + (response.length > 200 ? '...' : '');
        }
      } else {
        lastResponseEl.textContent = 'Request failed or no response';
      }
    }

    async function testApiKey() {
      if (isProcessing) return;
      
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (!apiKey) {
        logMessage("‚ùå Please enter your API key first", "error");
        showAlert("Please enter your API key first", "error");
        return;
      }

      setButtonLoading('testBtn', 'testBtnText', true, 'Testing...');
      logMessage("üß™ Testing API key with sample data...", "info");
      showAlert("Testing API connection...", "info");
      
      const response = await fetchEmail('John', 'Doe', 'intercom.com', apiKey);
      if (response) {
        logMessage("üéâ API test successful! Your key is working.", "success");
        showAlert("API test successful! Your key is working.", "success");
        try {
          const jsonResponse = JSON.parse(response);
          if (jsonResponse.response?.email) {
            logMessage(`üìß Found email: ${jsonResponse.response.email}`, "success");
          }
        } catch (e) {
          // Response parsing error, but request was successful
        }
      } else {
        logMessage("‚ùå API test failed. Please check your API key.", "error");
        showAlert("API test failed. Please check your API key and internet connection.", "error");
      }
      
      updateLastResponse(response);
      setButtonLoading('testBtn', 'testBtnText', false, 'üß™ Quick API Test');
    }

    async function processCSV() {
      if (isProcessing) return;
      
      const fileInput = document.getElementById('fileInput');
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      
      if (!apiKey) {
        logMessage("‚ùå Please enter your API key first", "error");
        showAlert("Please enter your API key first", "error");
        return;
      }
      
      if (!fileInput.files.length) {
        logMessage("‚ùå Please upload a CSV file", "error");
        showAlert("Please upload a CSV file", "error");
        return;
      }

      isProcessing = true;
      setButtonLoading('processBtn', 'processBtnText', true, 'Processing...');
      document.getElementById('progressSection').style.display = 'block';
      
      const file = fileInput.files[0];
      logMessage(`üìÅ Starting to process file: ${file.name}`, "info");
      showAlert(`Starting to process ${file.name}`, "info");
      
      Papa.parse(file, {
        header: true,
        complete: async function(results) {
          const validRows = results.data.filter(row => row.company && row.company.trim());
          totalCount = validRows.length;
          logMessage(`üìä Found ${validRows.length} valid rows to process`, "info");
          logMessage(`‚è±Ô∏è Estimated time: ${Math.ceil(validRows.length * 1.5 / 60)} minutes`, "info");
          showAlert(`Found ${validRows.length} valid rows. Processing will take approximately ${Math.ceil(validRows.length * 1.5 / 60)} minutes.`, "info");
          
          const enrichedData = [];
          let processed = 0;
          let found = 0;
          
          for (const row of validRows) {
            const { first_name, last_name, company } = row;
            processed++;
            
            logMessage(`[${processed}/${validRows.length}] Processing: ${first_name || 'N/A'} ${last_name || 'N/A'} @ ${company}`, "info");
            
            const response = await fetchEmail(first_name, last_name, company, apiKey);
            let enrichedRow = { ...row, email: '', email_status: 'NO_RESULT' };
            
            if (response) {
              try {
                const jsonResponse = JSON.parse(response);
                enrichedRow = {
                  ...row,
                  email: jsonResponse.response?.email || '',
                  email_status: jsonResponse.response?.email_status || 'NO_RESULT'
                };
                
                if (jsonResponse.response?.email) {
                  found++;
                  logMessage(`‚úÖ Found: ${jsonResponse.response.email}`, "success");
                } else {
                  logMessage(`‚ùå No email found for ${first_name} ${last_name}`, "error");
                }
              } catch (e) {
                logMessage(`‚ùå Error parsing response for ${first_name} ${last_name}`, "error");
              }
            }
            
            enrichedData.push(enrichedRow);
            updateLastResponse(response);
            updateProgress(processed, validRows.length, found);
            
            // Rate limiting - wait 1.5 seconds between requests
            if (processed < validRows.length) {
              logMessage(`‚è≥ Waiting 1.5s for rate limiting...`, "info");
              await new Promise(resolve => setTimeout(resolve, 1500));
            }
          }
          
          if (enrichedData.length > 0) {
            downloadCSV(enrichedData);
            logMessage(`üéâ Processing complete! Downloaded ${enrichedData.length} enriched records`, "success");
            showAlert(`Processing complete! Found ${found} emails out of ${processed} records. File downloaded successfully.`, "success");
          } else {
            logMessage("‚ùå No data to download", "error");
            showAlert("No data to download", "error");
          }
          
          isProcessing = false;
          setButtonLoading('processBtn', 'processBtnText', false, 'üöÄ Process CSV');
          document.getElementById('progressSection').style.display = 'none';
        },
        error: function(error) {
          logMessage(`‚ùå CSV parsing error: ${error.message}`, "error");
          showAlert(`CSV parsing error: ${error.message}`, "error");
          isProcessing = false;
          setButtonLoading('processBtn', 'processBtnText', false, 'üöÄ Process CSV');
          document.getElementById('progressSection').style.display = 'none';
        }
      });
    }

    function downloadCSV(data) {
      try {
        const csv = Papa.unparse(data);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `enriched_emails_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        logMessage("üì• Enriched CSV file downloaded successfully!", "success");
      } catch (error) {
        logMessage(`‚ùå Download error: ${error.message}`, "error");
        showAlert(`Download error: ${error.message}`, "error");
      }
    }

    function clearLogs() {
      document.getElementById('log').innerHTML = 'Logs cleared. Ready for new processing! üöÄ<br>';
      document.getElementById('lastResponse').textContent = 'No recent responses';
      document.getElementById('alertContainer').innerHTML = '';
    }

    function setButtonLoading(btnId, textId, loading, text) {
      const btn = document.getElementById(btnId);
      const textEl = document.getElementById(textId);
      
      btn.disabled = loading;
      if (loading) {
        textEl.innerHTML = `<span class="loading"></span> ${text}`;
      } else {
        textEl.textContent = text;
      }
    }

    // Auto-focus on API key input
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('apiKeyInput').focus();
      showAlert("Welcome! Please enter your Prospeo API key and test the connection before processing CSV files.", "info");
    });
  </script>
</body>
</html>