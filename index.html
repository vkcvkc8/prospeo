<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prospeo Email Finder Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #2d3748;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      color: #718096;
      font-size: 1.1rem;
    }

    .search-section {
      background: #f8fafc;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      border: 2px solid #e2e8f0;
    }

    .search-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .input-group label {
      font-weight: 600;
      color: #4a5568;
      font-size: 0.9rem;
    }

    input[type="text"], input[type="file"] {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      background: white;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 140px;
      justify-content: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #cbd5e0;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #38a169;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #e53e3e;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .stats-section {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 2px solid #e2e8f0;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #718096;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .results-section {
      background: #f8fafc;
      border-radius: 12px;
      padding: 25px;
      border: 2px solid #e2e8f0;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .results-header h3 {
      color: #2d3748;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      background: white;
      max-height: 400px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    th {
      background: #667eea;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:hover {
      background: #f7fafc;
    }

    .email-found {
      color: #38a169;
      font-weight: 600;
    }

    .email-not-found {
      color: #e53e3e;
      font-style: italic;
    }

    .log-section {
      margin-top: 25px;
      background: #f8fafc;
      border-radius: 12px;
      padding: 25px;
      border: 2px solid #e2e8f0;
    }

    .log-section h3 {
      color: #2d3748;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }

    #log {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      background: white;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.4;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: #e53e3e;
    }

    .success {
      color: #38a169;
    }

    .info {
      color: #3182ce;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #718096;
    }

    .empty-state h4 {
      margin-bottom: 10px;
      color: #4a5568;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .search-form {
        grid-template-columns: 1fr;
      }
      
      .stats-section {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîç Prospeo Email Finder</h1>
      <p>Find professional email addresses with advanced search and bulk processing</p>
    </div>

    <div class="search-section">
      <div class="search-form">
        <div class="input-group">
          <label for="firstNameInput">First Name</label>
          <input type="text" id="firstNameInput" placeholder="Enter first name...">
        </div>
        <div class="input-group">
          <label for="lastNameInput">Last Name</label>
          <input type="text" id="lastNameInput" placeholder="Enter last name...">
        </div>
        <div class="input-group">
          <label for="companyInput">Company *</label>
          <input type="text" id="companyInput" placeholder="Enter company domain...">
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="searchSingle()" id="searchSingleBtn">
          <span id="searchSingleText">üîç Search Single</span>
        </button>
        <button class="btn-primary" onclick="document.getElementById('fileInput').click()" id="bulkSearchBtn">
          <span id="bulkSearchText">üìÅ Search Bulk</span>
        </button>
        <button class="btn-secondary" onclick="stopProcessing()" id="stopBtn" disabled>
          <span>‚èπÔ∏è Stop</span>
        </button>
        <button class="btn-success" onclick="exportResults()" id="exportBtn" disabled>
          <span>üì• Export Results</span>
        </button>
        <button class="btn-danger" onclick="clearAll()" id="clearBtn">
          <span>üóëÔ∏è Clear All</span>
        </button>
      </div>

      <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileUpload(event)">
    </div>

    <div class="stats-section">
      <div class="stat-card">
        <div class="stat-number" id="totalSearches">0</div>
        <div class="stat-label">Total Searches</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="contactsFound">0</div>
        <div class="stat-label">Contacts Found</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="sourcesUsed">1</div>
        <div class="stat-label">Sources Used</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="successRate">0%</div>
        <div class="stat-label">Success Rate</div>
      </div>
    </div>

    <div class="results-section">
      <div class="results-header">
        <h3>üìä Search Results</h3>
        <span id="searchStatus">Ready to search</span>
      </div>
      
      <div class="table-container">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Company</th>
              <th>Email</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="resultsTableBody">
            <tr>
              <td colspan="6" class="empty-state">
                <h4>No search results yet</h4>
                <p>Use single search or upload a CSV file to get started</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="log-section">
      <h3>üìù Processing Logs</h3>
      <div id="log">Welcome to Prospeo Email Finder! üéâ<br>Ready to find professional email addresses.<br><br>Instructions:<br>1. For single search: Enter name and company, click "Search Single"<br>2. For bulk search: Click "Search Bulk" to upload CSV file<br>3. Export results when done<br><br>‚ö†Ô∏è Note: If you see CORS errors, the app will try alternative methods automatically.<br><br>Let's get started! üöÄ</div>
    </div>
  </div>

  <script>
  
  <!-- Fallback script for testing API connectivity -->
  <script>
    // Test API connectivity on page load
    window.addEventListener('load', function() {
      setTimeout(() => {
        fetch('https://api.prospeo.io/email-finder', {
          method: 'OPTIONS',
          headers: {
            'X-KEY': 'e89cd25c23ea559352eb96d0bc2c4c68'
          }
        }).then(response => {
          if (response.ok) {
            console.log('‚úÖ API connectivity test passed');
          } else {
            console.log('‚ö†Ô∏è API connectivity test failed - CORS proxy will be used');
          }
        }).catch(error => {
          console.log('‚ö†Ô∏è API connectivity test failed - CORS proxy will be used');
        });
      }, 1000);
    });
  </script>
    // Integrated API key - no need to enter manually
    const PROSPEO_API_KEY = 'e89cd25c23ea559352eb96d0bc2c4c68';
    
    let isProcessing = false;
    let shouldStop = false;
    let searchResults = [];
    let totalSearches = 0;
    let contactsFound = 0;

    async function fetchEmail(firstName, lastName, company) {
      if (!company) {
        logMessage("‚ùå Error: Company field is required", "error");
        return null;
      }

      const url = '/api/email-finder';
      const data = {
        first_name: firstName || '',
        last_name: lastName || '',
        company: company,
        api_key: PROSPEO_API_KEY
      };

      try {
        logMessage(`üîç Searching for: ${firstName} ${lastName} @ ${company}`, "info");
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        const result = await response.text();
        logMessage(`‚úÖ API request successful for ${firstName} ${lastName}`, "success");
        return result;
      } catch (error) {
        logMessage(`‚ùå Fetch error: ${error.message}`, "error");
        return null;
      }
    }

    function logMessage(message, type = "info") {
      const log = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === "error" ? "error" : type === "success" ? "success" : "info";
      log.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span><br>`;
      log.scrollTop = log.scrollHeight;
    }

    function updateStats() {
      document.getElementById('totalSearches').textContent = totalSearches;
      document.getElementById('contactsFound').textContent = contactsFound;
      const successRate = totalSearches > 0 ? Math.round((contactsFound / totalSearches) * 100) : 0;
      document.getElementById('successRate').textContent = successRate + '%';
    }

    function addResultToTable(firstName, lastName, company, email, status, index) {
      const tbody = document.getElementById('resultsTableBody');
      
      // Remove empty state if it exists
      if (tbody.children.length === 1 && tbody.children[0].children.length === 1) {
        tbody.innerHTML = '';
      }

      const row = document.createElement('tr');
      const fullName = `${firstName || ''} ${lastName || ''}`.trim() || 'N/A';
      const emailDisplay = email || 'Not found';
      const emailClass = email ? 'email-found' : 'email-not-found';
      
      row.innerHTML = `
        <td>${index}</td>
        <td>${fullName}</td>
        <td>${company}</td>
        <td class="${emailClass}">${emailDisplay}</td>
        <td>${status}</td>
        <td>
          <button class="btn-secondary" onclick="selectResult(${index - 1})" style="padding: 5px 10px; font-size: 12px;">
            Select
          </button>
        </td>
      `;
      
      tbody.appendChild(row);
    }

    function selectResult(index) {
      const result = searchResults[index];
      if (result) {
        logMessage(`üìã Selected: ${result.firstName} ${result.lastName} - ${result.email || 'No email'}`, "info");
      }
    }

    async function searchSingle() {
      if (isProcessing) return;
      
      const firstName = document.getElementById('firstNameInput').value.trim();
      const lastName = document.getElementById('lastNameInput').value.trim();
      const company = document.getElementById('companyInput').value.trim();
      
      if (!company) {
        logMessage("‚ùå Please enter a company domain", "error");
        return;
      }

      setButtonLoading('searchSingleBtn', 'searchSingleText', true, 'Searching...');
      document.getElementById('searchStatus').textContent = 'Searching...';
      
      const response = await fetchEmail(firstName, lastName, company);
      let email = '';
      let status = 'NO_RESULT';
      
      if (response) {
        try {
          const jsonResponse = JSON.parse(response);
          email = jsonResponse.response?.email || '';
          status = jsonResponse.response?.email_status || 'NO_RESULT';
          
          if (email) {
            logMessage(`üéâ Found email: ${email}`, "success");
            contactsFound++;
          } else {
            logMessage(`‚ùå No email found for ${firstName} ${lastName}`, "error");
          }
        } catch (e) {
          logMessage(`‚ùå Error parsing response`, "error");
        }
      }
      
      totalSearches++;
      const result = { firstName, lastName, company, email, status };
      searchResults.push(result);
      
      addResultToTable(firstName, lastName, company, email, status, totalSearches);
      updateStats();
      
      document.getElementById('exportBtn').disabled = false;
      document.getElementById('searchStatus').textContent = 'Search completed';
      setButtonLoading('searchSingleBtn', 'searchSingleText', false, 'üîç Search Single');
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      logMessage(`üìÅ Processing file: ${file.name}`, "info");
      processCSV(file);
    }

    async function processCSV(file) {
      if (isProcessing) return;
      
      isProcessing = true;
      shouldStop = false;
      setButtonLoading('bulkSearchBtn', 'bulkSearchText', true, 'Processing...');
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('searchStatus').textContent = 'Processing CSV...';
      
      Papa.parse(file, {
        header: true,
        complete: async function(results) {
          const validRows = results.data.filter(row => row.company && row.company.trim());
          logMessage(`üìä Found ${validRows.length} valid rows to process`, "info");
          logMessage(`‚è±Ô∏è Estimated time: ${Math.ceil(validRows.length * 1.5 / 60)} minutes`, "info");
          
          let processed = 0;
          
          for (const row of validRows) {
            if (shouldStop) {
              logMessage("‚èπÔ∏è Processing stopped by user", "info");
              break;
            }
            
            const { first_name, last_name, company } = row;
            processed++;
            
            logMessage(`[${processed}/${validRows.length}] Processing: ${first_name || 'N/A'} ${last_name || 'N/A'} @ ${company}`, "info");
            
            const response = await fetchEmail(first_name, last_name, company);
            let email = '';
            let status = 'NO_RESULT';
            
            if (response) {
              try {
                const jsonResponse = JSON.parse(response);
                email = jsonResponse.response?.email || '';
                status = jsonResponse.response?.email_status || 'NO_RESULT';
                
                if (email) {
                  logMessage(`‚úÖ Found: ${email}`, "success");
                  contactsFound++;
                } else {
                  logMessage(`‚ùå No email found`, "error");
                }
              } catch (e) {
                logMessage(`‚ùå Error parsing response`, "error");
              }
            }
            
            totalSearches++;
            const result = { 
              firstName: first_name, 
              lastName: last_name, 
              company, 
              email, 
              status,
              ...row 
            };
            searchResults.push(result);
            
            addResultToTable(first_name, last_name, company, email, status, totalSearches);
            updateStats();
            
            // Rate limiting - wait 1.5 seconds between requests
            if (processed < validRows.length && !shouldStop) {
              logMessage(`‚è≥ Waiting 1.5s for rate limiting...`, "info");
              await new Promise(resolve => setTimeout(resolve, 1500));
            }
          }
          
          if (searchResults.length > 0) {
            document.getElementById('exportBtn').disabled = false;
            logMessage(`üéâ Processing complete! Found ${contactsFound} emails from ${totalSearches} searches`, "success");
          }
          
          isProcessing = false;
          shouldStop = false;
          document.getElementById('stopBtn').disabled = true;
          document.getElementById('searchStatus').textContent = 'Processing completed';
          setButtonLoading('bulkSearchBtn', 'bulkSearchText', false, 'üìÅ Search Bulk');
        },
        error: function(error) {
          logMessage(`‚ùå CSV parsing error: ${error.message}`, "error");
          isProcessing = false;
          setButtonLoading('bulkSearchBtn', 'bulkSearchText', false, 'üìÅ Search Bulk');
        }
      });
    }

    function stopProcessing() {
      shouldStop = true;
      logMessage("‚èπÔ∏è Stopping processing...", "info");
    }

    function exportResults() {
      if (searchResults.length === 0) {
        logMessage("‚ùå No results to export", "error");
        return;
      }
      
      try {
        const exportData = searchResults.map(result => ({
          first_name: result.firstName || '',
          last_name: result.lastName || '',
          company: result.company || '',
          email: result.email || '',
          email_status: result.status || 'NO_RESULT'
        }));
        
        const csv = Papa.unparse(exportData);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `prospeo_results_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        logMessage("üì• Results exported successfully!", "success");
      } catch (error) {
        logMessage(`‚ùå Export error: ${error.message}`, "error");
      }
    }

    function clearAll() {
      if (confirm('Are you sure you want to clear all results?')) {
        searchResults = [];
        totalSearches = 0;
        contactsFound = 0;
        
        const tbody = document.getElementById('resultsTableBody');
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <h4>No search results yet</h4>
              <p>Use single search or upload a CSV file to get started</p>
            </td>
          </tr>
        `;
        
        updateStats();
        document.getElementById('exportBtn').disabled = true;
        document.getElementById('searchStatus').textContent = 'Ready to search';
        
        // Clear input fields
        document.getElementById('firstNameInput').value = '';
        document.getElementById('lastNameInput').value = '';
        document.getElementById('companyInput').value = '';
        
        logMessage("üßπ All results cleared", "info");
      }
    }

    function setButtonLoading(btnId, textId, loading, text) {
      const btn = document.getElementById(btnId);
      const textEl = document.getElementById(textId);
      
      btn.disabled = loading;
      if (loading) {
        textEl.innerHTML = `<span class="loading"></span> ${text}`;
      } else {
        textEl.textContent = text;
      }
    }

    // Auto-focus on first name input
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('firstNameInput').focus();
    });
  </script>
</body>
</html>